<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Matheus IA</title>
  
  <!-- WaveSurfer.js para visualiza√ß√£o da waveform -->
  <script src="https://unpkg.com/wavesurfer.js@7"></script>
  
  <style>
    /* -------------------------------------------------------------------------
       1. Configura√ß√£o de Fundo e Tema
       ------------------------------------------------------------------------- */
    /* Fonte Poppins (substituindo Inter) */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');

    /* Vari√°veis de Cores (Ajustadas para o novo tema azul/roxo) */
    :root {
        --color-background-deep: #0c0a18; /* Novo fundo escuro */
        --color-text-light: #F3F4F6;
        --color-accent-blue: #38bdf8; /* Azul claro / Ciano */
        --color-accent-dark-blue: #0e85e9; /* Azul escuro */
        --color-whatsapp-green: #4ade80;
        --color-surface-glass: rgba(255, 255, 255, 0.05);
        --color-border-glass: rgba(255, 255, 255, 0.15);
        /* Vari√°veis de fallback para o JS */
        --background-color: var(--color-background-deep);
        --accent-color: var(--color-accent-blue);
        --accent-color-dark: var(--color-accent-dark-blue);
        --primary-text-color: var(--color-text-light);
    }

    body {
        /* 1.1 Tema Escuro e Fonte */
        font-family: 'Poppins', sans-serif;
        background-color: var(--color-background-deep) !important; /* Overwrite do background */
        color: var(--color-text-light);
        min-height: 100vh;
        overflow-x: hidden;
        margin: 0;
        padding: 0 20px;
        text-align: center;
        
        /* NOVO: Flexbox para centralizar o conte√∫do verticalmente */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center; 
    }

    /* Camada fixa com imagem de fundo (1.2) */
    #background-image-layer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj9SjCq03vOSHR9A0J0kwOG3HaquJkYJH_YverBC5YWBRQfOGsxxASZipfkuTGJlbRE_s7TAKdKO7vIkcAJcgtySe6cp7H2hW9iAodcjSWfY-t5niYGNnuP3ZTaFsNIWMsM3xVi_IkC3KaN/s1600/papel-de-parede-do-internacional-wallpaper+(4).jpg'); /* Imagem do GIGANTUDO COLORADO */
        background-size: cover;
        background-position: center;
        opacity: 0.05; /* Opacidade extremamente baixa */
        z-index: -2;
        pointer-events: none;
    }

    /* Camada fixa do Fundo Estrelado Animado (1.2) */
    #star-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 200vh; /* Altura aumentada para permitir o scroll de estrelas */
        z-index: -1;
        pointer-events: none;
        overflow: hidden;
    }

    /* Estrela individual */
    .star {
        position: absolute;
        background-color: var(--color-text-light);
        border-radius: 50%;
        animation-name: move-stars;
        animation-timing-function: linear;
        animation-iteration-count: infinite;
    }

    /* Keyframe para o movimento vertical cont√≠nuo (1.2) */
    @keyframes move-stars {
        from { transform: translateY(0px); }
        to { transform: translateY(-2000px); } /* Move para cima */
    }
    
    .content-wrapper {
        position: relative;
        z-index: 10; /* Aumentado para garantir que fique acima dos fundos */
        max-width: 800px;
        width: 100%;
        margin: 0 auto;
        /* NOVO: Ajuste para centraliza√ß√£o vertical (removido padding de 20px do body e movido para c√°) */
        padding: 20px 0; 
        flex-grow: 0;
    }

    /* -------------------------------------------------------------------------
       2. Anima√ß√µes de Revela√ß√£o e Destaque
       ------------------------------------------------------------------------- */

    /* Keyframe de revela√ß√£o de palavra (2.1) */
    @keyframes reveal-word {
        0% {
            opacity: 0;
            transform: translateY(30px) rotate(5deg);
            filter: blur(5px);
        }
        100% {
            opacity: 1;
            transform: translateY(0) rotate(0deg);
            filter: blur(0);
        }
    }

    /* Estilo para cada palavra span dentro da headline */
    .animate-headline {
        display: flex;
        flex-wrap: wrap; /* Permite quebras de linha em telas pequenas */
        align-items: center;
        justify-content: center;
        gap: 15px; /* Ajuste o gap agora que o √≠cone foi removido */
        font-size: clamp(1.8rem, 5vw, 2.5rem);
        font-weight: 700;
        letter-spacing: 1.5px;
        margin-bottom: 30px;
        color: var(--primary-text-color);
        /* NOVO: Removido o SVG, o gap agora √© apenas entre palavras */
        gap: 10px; 
    }
.animate-headline span {
  will-change: transform, opacity;
  backface-visibility: hidden;
  transform: translateZ(0);
}

    /* Keyframe de brilho pulsante (2.2) */
    @keyframes highlight-glow {
        0%, 100% {
            text-shadow: 0 0 10px rgba(56, 189, 248, 0.7), /* Azul sutil */
                         0 0 20px rgba(14, 165, 233, 0.5); /* Ciano sutil */
        }
        50% {
            text-shadow: 0 0 25px rgba(56, 189, 248, 1), /* Azul intenso */
                         0 0 40px rgba(14, 165, 233, 0.8), /* Ciano intenso */
                         0 0 60px rgba(56, 189, 248, 0.5);
        }
    }

    /* Aplica√ß√£o do brilho √† palavra de destaque */
.highlight-word {
  color: var(--color-accent-blue);
  animation: highlight-glow 1.0s ease-in-out forwards; /* executa s√≥ uma vez */
  will-change: text-shadow;
}

    /* Keyframe para fade in up (2.3) */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fade-in-up {
        opacity: 0; /* Estado inicial oculto */
        animation-name: fadeInUp;
        animation-duration: 0.8s;
        animation-timing-function: ease-out;
        animation-fill-mode: forwards;
        /* animation-delay vir√° inline via JS/HTML */
    }

    /* -------------------------------------------------------------------------
       3. Efeito de Scroll (Intersection Observer)
       ------------------------------------------------------------------------- */
    .scroll-animate {
        transition: opacity 0.8s ease-out, transform 0.8s ease-out;
        opacity: 0;
        transform: translateY(40px);
    }

    .scroll-animate.visible {
        opacity: 1;
        transform: translateY(0);
    }

    /* -------------------------------------------------------------------------
       4. Estiliza√ß√£o de Bot√µes Transl√∫cidos e Brilho
       ------------------------------------------------------------------------- */

    /* Keyframe de Brilho de Bot√£o (4.1) */
    @keyframes pulse-glow {
        0% { box-shadow: 0 0 5px rgba(56, 189, 248, 0.5); }
        50% { box-shadow: 0 0 15px rgba(56, 189, 248, 0.8), 0 0 25px rgba(14, 165, 233, 0.4); }
        100% { box-shadow: 0 0 5px rgba(56, 189, 248, 0.5); }
    }

    @keyframes pulse-glow-whatsapp {
        0% { box-shadow: 0 0 5px rgba(74, 222, 128, 0.5); }
        50% { box-shadow: 0 0 15px rgba(74, 222, 128, 0.8), 0 0 25px rgba(22, 163, 74, 0.4); }
        100% { box-shadow: 0 0 5px rgba(74, 222, 128, 0.5); }
    }

    .btn-translucent {
        /* Glass-Morphism futurista (4.1) */
        position: relative;
        overflow: hidden;
        border-radius: 12px;
        padding: 1rem 2rem;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.3s ease;
        z-index: 0; /* Para o :before funcionar */

        /* Estilos Glass-Morphism */
        background-color: rgba(14, 165, 233, 0.15); /* Azul transl√∫cido */
        border: 1px solid rgba(14, 165, 233, 0.4); /* Borda sutil */
        backdrop-filter: blur(8px);
        color: var(--color-text-light); /* Cor do texto padr√£o */
        text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);

        /* Aplica a anima√ß√£o de brilho (4.1) */
        animation: pulse-glow 3s infinite alternate ease-in-out;
    }

    /* Efeito de hover (Brilho ::before) (4.2) */
    .btn-translucent::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%; /* Estado inicial: fora da tela √† esquerda */
        width: 25%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: transform 0.5s ease;
        transform: skewX(-20deg);
        z-index: -1;
    }

    .btn-translucent:hover::before {
        /* Move o brilho da esquerda para a direita */
        transform: translateX(600%) skewX(-20deg); /* Move para 150% + 500% */
    }

    /* Varianta WhatsApp (4.3) - Mantida por seguran√ßa, embora n√£o usada */
    .btn-translucent-whatsapp {
        background-color: rgba(74, 222, 128, 0.15); /* Verde transl√∫cido */
        border: 1px solid rgba(74, 222, 128, 0.4);
        animation: pulse-glow-whatsapp 3s infinite ease-in-out; /* Anima√ß√£o verde */
    }
    .btn-translucent-whatsapp::before {
        /* Mant√©m o brilho do hover branco */
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    }

    /* -------------------------------------------------------------------------
       6. Estiliza√ß√£o de Cards (Testimonial Card)
       ------------------------------------------------------------------------- */
    .testimonial-card {
        /* Glass-Morphism Sutil (6.1) */
        background-color: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    /* -------------------------------------------------------------------------
       Estilos de Componentes Existentes (Ajustes para o novo tema)
       ------------------------------------------------------------------------- */
    /* Substitui o estilo do modal para usar o Glass-Morphism ajustado */
    #paramModal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.4s ease-out;
    }
    #paramModal.visible {
        opacity: 1;
    }
    #paramModal .modal-content {
        background: rgba(12, 10, 24, 0.9); /* Fundo escuro levemente transparente */
        backdrop-filter: blur(15px);
        padding: 30px 35px;
        width: 90%;
        max-width: 420px;
        border-radius: 20px;
        text-align: left;
        border: 1px solid rgba(14, 165, 233, 0.4); /* Borda com a cor de destaque */
        box-shadow: 0 0 30px rgba(14, 165, 233, 0.3); /* Brilho sutil */
        animation-duration: 0.4s;
        animation-timing-function: ease-out;
        transform: translateY(-20px);
        transition: transform 0.4s ease-out;
    }
    #paramModal.visible .modal-content {
        transform: translateY(0);
    }
    .param-group {
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
    }
    .param-group label {
        font-weight: 500;
        margin-bottom: 5px;
        color: var(--color-accent-blue);
    }
    .param-group output {
        margin-left: 10px;
        font-weight: 700;
    }
    input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        outline: none;
        opacity: 0.7;
        transition: opacity .2s;
    }
    input[type="range"]:hover {
        opacity: 1;
    }
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--color-accent-blue);
        cursor: pointer;
        box-shadow: 0 0 10px var(--color-accent-blue);
    }
    select, #applyParams {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid var(--color-border-glass);
        background: rgba(255, 255, 255, 0.1);
        color: var(--color-text-light);
        margin-top: 5px;
        font-size: 1em;
    }

    /* Ajusta o fundo da zona de drop para usar o Glass-Morphism */
    #dropZone {
        /* NOVO: Flexbox para centralizar o √≠cone e o texto */
        display: flex; 
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center; 
        
        /* Substitui estilos existentes */
        border: 2px dashed rgba(14, 165, 233, 0.5);
        background: rgba(12, 10, 24, 0.5);
        backdrop-filter: blur(12px);
        transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        box-shadow: 0 0 15px rgba(14, 165, 233, 0.2);
        padding: 60px 30px;
        border-radius: 15px;
        font-size: 1.2em;
        cursor: pointer;
    }
    #dropZone.hover {
        border-color: var(--color-accent-blue);
        background: rgba(14, 165, 233, 0.1);
        box-shadow: 0 0 30px var(--color-accent-blue);
        transform: scale(1.02);
    }
    #dropZone.processing {
        /* Usa o brilho azul no pulso */
        animation: pulse-glow 2s infinite ease-in-out;
        cursor: not-allowed;
        background: rgba(14, 165, 233, 0.1);
    }
    
    #status {
        margin: 20px 0;
        font-weight: 500;
        color: var(--color-accent-blue);
    }
    
    #progressContainer {
        display: none;
        width: 100%;
        height: 10px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 5px;
        margin: 20px 0;
        overflow: hidden;
    }
    #progressBar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--color-accent-dark-blue), var(--color-accent-blue));
        box-shadow: 0 0 15px var(--color-accent-blue);
        transition: width 0.3s ease-out;
    }

    /* Garante que o container do player utilize o Glass-Morphism ajustado */
    #playerContainer {
        display: flex;
        flex-direction: column;
        gap: 20px;
        background: rgba(12, 10, 24, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(14, 165, 233, 0.4);
        box-shadow: 0 0 20px rgba(14, 165, 233, 0.3);
        border-radius: 15px;
        padding: 20px;
        margin-top: 30px;
    }
    .audio-display {
        text-align: left;
    }
    .audio-display h4 {
        margin-top: 0;
        margin-bottom: 10px;
        color: var(--color-accent-blue);
        font-weight: 600;
        font-size: 1.1em;
    }
    .audio-player-wrapper {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .waveform-container {
        flex-grow: 1;
        min-width: 0; /* Permite que o flex container se ajuste */
    }

    /* Estilo do bot√£o de play */
    .play-button {
        background-color: transparent;
        border: 2px solid var(--color-accent-blue);
        color: var(--color-accent-blue);
        box-shadow: 0 0 10px rgba(56, 189, 248, 0.5);
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .play-button svg {
        width: 20px;
        height: 20px;
        fill: currentColor;
    }
    .play-button:hover {
        background-color: var(--color-accent-blue);
        color: var(--color-background-deep);
        border-color: var(--color-accent-blue);
        transform: scale(1.15);
        box-shadow: 0 0 20px var(--color-accent-blue);
    }
    
    .results-buttons {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 30px;
    }

    /* Ajuste do bot√£o de download */
    #downloadBtn {
        /* Usa a classe .btn-translucent */
        display: none; /* Controlado pelo JS */
        align-items: center;
        gap: 10px;
        font-size: 0.95em;
        /* Estilos espec√≠ficos que sobrescrevem a base translucent */
        background: var(--color-accent-blue);
        color: var(--color-background-deep);
        border: none;
        text-shadow: none;
        box-shadow: 0 0 20px rgba(14, 165, 233, 0.8);
        font-weight: 700;
        animation: none; /* Remove pulse-glow padr√£o */
    }
    #downloadBtn:hover {
        background: var(--color-accent-dark-blue);
        box-shadow: 0 0 35px var(--color-accent-blue);
    }
    #downloadBtn.visible { display: flex; }
    
    #resetBtn {
        /* Estilo de bot√£o secund√°rio com Glass-Morphism */
        display: none; /* Controlado pelo JS */
        padding: 1rem 2rem;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        
        background: rgba(255, 255, 255, 0.1);
        color: var(--color-text-light);
        border: 1px solid var(--color-border-glass);
        backdrop-filter: blur(5px);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
    }
    #resetBtn:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: var(--color-accent-blue);
        box-shadow: 0 0 15px var(--color-accent-blue);
        color: var(--color-accent-blue);
    }
    #resetBtn.visible { display: block; }


    /* Ajusta o erro */
    .error { 
        color: var(--color-accent-blue); 
        text-shadow: 0 0 8px var(--color-accent-blue); 
    }

    /* --- Media Queries para Responsividade --- */
    @media (max-width: 600px) {
        body { padding: 10px; }
        .content-wrapper { padding: 0 10px; }
        #dropZone { padding: 40px 20px; font-size: 1em; }
        .animate-headline { font-size: 1.5rem; gap: 8px; }
        #playerContainer { padding: 15px; }
        .results-buttons { flex-direction: column; gap: 10px; }
        .play-button { width: 40px; height: 40px; }
        #downloadBtn, #resetBtn { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>
  <!-- Fundos Fixos (Injetados pelo JS) -->
  <div id="background-image-layer"></div>
  <div id="star-background"></div>

  <div class="content-wrapper">
    <!-- T√≠tulo Principal (NOVO T√çTULO E SEM √çCONE) -->
    <h1 class="animate-headline">Matheus IA de √°udio</h1> 
    
    <!-- Zona de Drop e Status (NOVO √çCONE DE UPLOAD ADICIONADO) -->
    <div id="dropZone" class="scroll-animate" style="--delay: 0.1s;">
        <!-- √çcone de Upload em SVG -->
        <svg id="uploadIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 40px; height: 40px; margin-bottom: 15px; color: var(--color-accent-blue);">
            <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"></path>
        </svg>
        Clique ou arraste um arquivo de √°udio aqui
    </div>
    <div id="status" class="scroll-animate" style="--delay: 0.3s;"></div>
    <div id="progressContainer" class="scroll-animate" style="--delay: 0.5s;"><div id="progressBar"></div></div>
    
    <!-- Player de √Åudio -->
    <div id="playerContainer" style="display: none;" class="scroll-animate" style="--delay: 0.7s;"> 
        <div class="audio-display">
            <h4>Antes</h4>
            <div class="audio-player-wrapper">
                <button id="playBtnOriginal" class="play-button" aria-label="Play/Pause Original Audio">
                    <svg id="playIconOriginal" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                    <svg id="pauseIconOriginal" viewBox="0 0 24 24" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
                </button>
                <div class="waveform-container">
                    <div id="waveformOriginal"></div>
                </div>
            </div>
        </div>
        <div class="audio-display">
            <h4>Depois</h4>
             <div class="audio-player-wrapper">
                <button id="playBtnEnhanced" class="play-button" aria-label="Play/Pause Enhanced Audio">
                    <svg id="playIconEnhanced" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                    <svg id="pauseIconEnhanced" viewBox="0 0 24 24" style="display:none;"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
                </button>
                <div class="waveform-container">
                    <div id="waveformEnhanced"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bot√µes de Resultado -->
    <div class="results-buttons">
      <!-- Usando a nova classe de bot√£o -->
      <a id="downloadBtn" download="enhanced_audio.mp3" class="btn-translucent scroll-animate" style="--delay: 0.9s;">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z"></path></svg>
          <span>Baixar √Åudio Melhorado</span>
      </a>
      <button id="resetBtn" class="scroll-animate" style="--delay: 1.1s;">Melhorar Novo √Åudio</button>
    </div>
  </div>

  <!-- Modal de par√¢metros -->
  <div id="paramModal">
    <div class="modal-content">
      <h3>Configura√ß√µes de Aprimoramento</h3>
      <div class="param-group">
        <label for="enhancement_level">N√≠vel de Processamento <output id="enhancement_level_value">100</output></label>
        <input type="range" id="enhancement_level" value="100" min="0" max="100" oninput="enhancement_level_value.value = this.value">
      </div>
       <div class="param-group">
        <label for="loudness_target">Loudness Target (LUFS) <output id="loudness_target_value">-14</output></label>
        <input type="range" id="loudness_target" value="-14" min="-40" max="-5" oninput="loudness_target_value.value = this.value">
      </div>
      <div class="param-group">
        <label for="true_peak">True Peak (dBTP) <output id="true_peak_value">-1</output></label>
        <input type="range" id="true_peak" value="-1" min="-9" max="0" step="1" oninput="true_peak_value.value = this.value">
      </div>
      <div class="param-group">
        <label for="enhancement_model">Modelo</label>
        <select id="enhancement_model">
          <option value="LARK_V2">LARK_V2 (Recomendado)</option>
          <option value="LARK">LARK</option>
          <option value="FINCH">FINCH</option>
        </select>
      </div>
      <div class="param-group">
        <label for="transcode">Formato</label>
        <select id="transcode">
          <option value="MP3">MP3</option>
          <option value="WAV">WAV</option>
        </select>
      </div>
      <button id="applyParams" class="btn-translucent">Aplicar e Processar</button>
    </div>
  </div>

<script>
const API_KEY = "9f1c9a6d785ae359b7e9fac9de07349c8a9c0bd2cd6f69d47ddcbcd7a01d8c48";
const API_URL = "https://api.ai-coustics.io/v2/medias";

// --- Vari√°veis Globais e Elementos do DOM ---
let selectedFile = null;
let mediaUid = null;
let waveSurferOriginal, waveSurferEnhanced;

const dropZone = document.getElementById("dropZone");
const statusDiv = document.getElementById("status");
const downloadBtn = document.getElementById("downloadBtn");
const resetBtn = document.getElementById('resetBtn');
const modal = document.getElementById("paramModal");
const applyParamsBtn = document.getElementById("applyParams");
const progressContainer = document.getElementById("progressContainer");
const progressBar = document.getElementById("progressBar");
const playerContainer = document.getElementById("playerContainer");

const playBtnOriginal = document.getElementById('playBtnOriginal');
const playIconOriginal = document.getElementById('playIconOriginal');
const pauseIconOriginal = document.getElementById('pauseIconOriginal');

const playBtnEnhanced = document.getElementById('playBtnEnhanced');
const playIconEnhanced = document.getElementById('playIconEnhanced');
const pauseIconEnhanced = document.getElementById('pauseIconEnhanced');

// --- NOVAS VARI√ÅVEIS DE ELEMENTOS ---
const headline = document.querySelector('.animate-headline');
const starBackground = document.getElementById('star-background');


// -------------------------------------------------------------------------
// Fun√ß√µes de Est√©tica e Intera√ß√£o
// -------------------------------------------------------------------------

/* 1.2. Fundo Estrelado Animado: Gera√ß√£o de Estrelas */
function generateStars() {
    const numStars = 150;
    const containerHeight = 2000; // Corresponde √† altura definida no CSS @keyframes move-stars
    for (let i = 0; i < numStars; i++) {
        const star = document.createElement('div');
        star.classList.add('star');
        
        // Posi√ß√£o e dimens√µes aleat√≥rias
        const size = Math.random() * 2 + 0.5; // Tamanho entre 0.5px e 2.5px
        star.style.width = `${size}px`;
        star.style.height = `${size}px`;
        star.style.left = `${Math.random() * 100}vw`; // Posi√ß√£o X aleat√≥ria
        star.style.top = `${Math.random() * containerHeight}px`; // Posi√ß√£o Y aleat√≥ria dentro do container de 2000px

        // Dura√ß√£o e Atraso de Anima√ß√£o aleat√≥rios para dispers√£o
        const duration = Math.random() * 20 + 10; // Dura√ß√£o entre 10s e 30s
        const delay = Math.random() * -duration; // Atraso negativo para come√ßar em um ponto aleat√≥rio da anima√ß√£o
        
        star.style.animationDuration = `${duration}s`;
        star.style.animationDelay = `${delay}s`;
        
        starBackground.appendChild(star);
    }
}

/* 2. Anima√ß√£o de Revela√ß√£o de Palavras (ATUALIZADA para o novo t√≠tulo) */
function setupHeadlineAnimation() {
    if (!headline) return;

    // 1. Obt√©m o texto original do H1
    const originalText = headline.textContent.trim();
    
    // 2. Divide o texto em palavras (mantendo a sequ√™ncia)
    const words = originalText.split(/\s+/).filter(word => word.length > 0);
    headline.innerHTML = ''; // Limpa o conte√∫do original

    // 3. Recria o HTML com cada palavra em um <span> com delay sequencial
    words.forEach((word, index) => {
        const wordSpan = document.createElement('span');
        wordSpan.textContent = word + ' '; // Adiciona o espa√ßo de volta ap√≥s a palavra
        
        // 2.1. Atraso sequencial de 0.1s
        wordSpan.style.animationDelay = `${index * 0.1}s`;
        wordSpan.style.animationName = 'reveal-word';
        wordSpan.style.animationDuration = '0.7s';
        
        // 2.2. Destaque a palavra "Matheus"
        if (word.toLowerCase() === 'matheus') {
            wordSpan.classList.add('highlight-word');
        }

        headline.appendChild(wordSpan);
    });
}

/* 3. Efeito de Scroll (Intersection Observer) */
function setupIntersectionObserver() {
    const elements = document.querySelectorAll('.scroll-animate');

    // Remove a classe 'visible' de todos os elementos para que a anima√ß√£o possa ser re-executada
    elements.forEach(element => {
        element.classList.remove('visible');
        element.style.transitionDelay = '0s'; // Reseta o delay
    });


    const observer = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const element = entry.target;
                
                // 3. Aplica a classe 'visible'
                element.classList.add('visible');
                
                // Aplica o delay inline (se estiver definido via CSS custom property)
                const delay = element.style.getPropertyValue('--delay');
                if (delay) {
                    element.style.transitionDelay = delay;
                }

                // Parar de observar depois de vis√≠vel
                observer.unobserve(element);
            }
        });
    }, {
        rootMargin: '0px',
        threshold: 0.1 // 10% do elemento vis√≠vel
    });

    elements.forEach(element => {
        observer.observe(element);
    });
}

// -------------------------------------------------------------------------
// Fun√ß√µes de Inicializa√ß√£o e L√≥gica Principal (Mantidas)
// -------------------------------------------------------------------------

// --- Fun√ß√µes de Inicializa√ß√£o das Waveforms ---
const createWaveSurfer = (containerId) => {
    return WaveSurfer.create({
        container: containerId,
        waveColor: 'rgba(255, 255, 255, 0.3)',
        progressColor: 'var(--accent-color)',
        barWidth: 5,
        barRadius: 5,
        barGap: 3,
        height: 100,
        cursorWidth: 2,
        cursorColor: '#fff',
        responsive: true,
        normalize: true,
    });
}

// Configura√ß√£o dos eventos de play/pause
function setupWaveSurferEvents(ws, otherWs, playIcon, pauseIcon) {
    ws.otherWs = otherWs; 

    ws.on('play', () => {
        // Pausa o outro √°udio quando este come√ßar a tocar
        if (ws.otherWs && ws.otherWs.isPlaying()) {
            ws.otherWs.pause();
        }
        playIcon.style.display = 'none';
        pauseIcon.style.display = 'block';
    });
    ws.on('pause', () => {
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
    });
    ws.on('finish', () => {
        ws.seekTo(0);
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
    });
}

// --- L√≥gica de Intera√ß√£o (Event Listeners) ---
function setupEventListeners() {
    dropZone.addEventListener("click", () => { if (!dropZone.classList.contains('processing')) triggerFileInput(); });
    dropZone.addEventListener("dragover", e => { e.preventDefault(); if (!dropZone.classList.contains('processing')) dropZone.classList.add("hover"); });
    dropZone.addEventListener("dragleave", () => dropZone.classList.remove("hover"));
    dropZone.addEventListener("drop", handleFileDrop);
    applyParamsBtn.addEventListener("click", () => { closeModal(); uploadFile(); });
    resetBtn.addEventListener('click', resetToInitialState);
    
    // Controles de Play/Pause - usam a l√≥gica em setupWaveSurferEvents
    playBtnOriginal.addEventListener('click', () => {
        if (waveSurferOriginal) {
            waveSurferOriginal.playPause();
        }
    });

    playBtnEnhanced.addEventListener('click', () => {
        if (waveSurferEnhanced) {
            waveSurferEnhanced.playPause();
        }
    });

    // Inclus√£o das novas funcionalidades est√©ticas
    generateStars(); 
    setupHeadlineAnimation(); 
    setupIntersectionObserver(); 
}

function triggerFileInput() {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "audio/*,video/*"; // Aceita √°udio e v√≠deo
    input.onchange = e => {
        if (e.target.files.length > 0) {
            selectedFile = e.target.files[0];
            openModal();
        }
    };
    input.click();
}

function handleFileDrop(e) {
    e.preventDefault();
    if (dropZone.classList.contains('processing')) return;
    dropZone.classList.remove("hover");
    if (e.dataTransfer.files.length > 0) {
        selectedFile = e.dataTransfer.files[0];
        openModal();
    }
}

// --- Controle do Modal ---
function openModal() {
    modal.style.display = "flex"; 
    // Garante que o display seja ativado antes da transi√ß√£o de opacidade
    setTimeout(() => { modal.classList.add("visible"); }, 10);
}
function closeModal() {
    modal.classList.remove("visible");
    setTimeout(() => { modal.style.display = "none"; }, 400); // 400ms = dura√ß√£o da transi√ß√£o CSS
}

// --- L√≥gica Principal (Upload e Processamento) ---
function resetToInitialState() {
    statusDiv.innerHTML = "";
    progressContainer.style.display = "none";
    progressBar.style.width = "0%";
    playerContainer.style.display = "none"; 
    downloadBtn.classList.remove('visible');
    resetBtn.classList.remove('visible');
    dropZone.classList.remove('processing');
    dropZone.style.display = 'flex'; // Volta para 'flex' para exibir o DropZone centralizado
    if (waveSurferOriginal) waveSurferOriginal.destroy();
    if (waveSurferEnhanced) waveSurferEnhanced.destroy();
    selectedFile = null;
    mediaUid = null;

    // Reinicia o Intersection Observer para reanimar elementos
    setupIntersectionObserver();
}

async function uploadFile() {
    if (!selectedFile) {
        statusDiv.innerHTML = `<div class="error">Nenhum arquivo selecionado.</div>`;
        return;
    }
    // Limpa a interface de resultados anteriores
    playerContainer.style.display = "none";
    downloadBtn.classList.remove('visible');
    resetBtn.classList.remove('visible');
    
    dropZone.classList.add('processing');
    statusDiv.innerText = "‚è≥ Enviando arquivo...";

    const params = {
        loudness_target: parseInt(document.getElementById("loudness_target").value),
        true_peak: parseInt(document.getElementById("true_peak").value),
        enhancement_level: parseInt(document.getElementById("enhancement_level").value),
        enhancement_model: document.getElementById("enhancement_model").value,
        transcode: document.getElementById("transcode").value
    };

    const formData = new FormData();
    formData.append("file", selectedFile);
    formData.append("media_enhancement", JSON.stringify(params));

    try {
        const resp = await fetch(API_URL, {
            method: "POST",
            headers: { "X-API-Key": API_KEY },
            body: formData
        });
        if (!resp.ok) {
            const errText = await resp.text();
            throw new Error(`Upload failed: ${resp.status} ${errText}`);
        }
        const data = await resp.json();
        mediaUid = data.uid;
        if (!mediaUid) { statusDiv.innerText = "‚ùå Erro no upload"; return; }
        
        // Carrega o √°udio original na waveform
        waveSurferOriginal = createWaveSurfer('#waveformOriginal');
        const originalUrl = URL.createObjectURL(selectedFile);
        waveSurferOriginal.load(originalUrl);
        // Temporariamente chamamos aqui para carregar o √≠cone.
        setupWaveSurferEvents(waveSurferOriginal, null, playIconOriginal, pauseIconOriginal); 

        statusDiv.innerText = "üì° Processando...";
        progressContainer.style.display = "block";
        simulateProgress();
        pollStatus();
    } catch (err) {
        handleError(err);
        dropZone.classList.remove('processing');
    }
}


function simulateProgress() {
    progressBar.style.width = "0%";
    let width = 0;
    const interval = setInterval(() => {
        if (width >= 90 || progressBar.style.width === "100%") { clearInterval(interval); return; }
        width += 5;
        progressBar.style.width = width + "%";
    }, 1000);
}

async function pollStatus() {
    if (!mediaUid) return;
    try {
        const resp = await fetch(`${API_URL}/${mediaUid}/metadata`, { headers: { "X-API-Key": API_KEY } });
        const data = await resp.json();
        
        if (data.enhancement_status === "COMPLETED") {
            statusDiv.innerText = "‚úÖ Pronto! Compare os √°udios abaixo.";
            progressBar.style.width = "100%";
            progressContainer.style.display = "none";
            dropZone.style.display = 'none'; // Oculta o DropZone quando o resultado √© exibido
            dropZone.classList.remove('processing');

            const fileResp = await fetch(`${API_URL}/${mediaUid}/file?step=ENHANCED`, { headers: { "X-API-Key": API_KEY } });
            if (!fileResp.ok) throw new Error("Erro ao baixar √°udio processado");
            const blob = await fileResp.blob();
            const url = window.URL.createObjectURL(blob);

            // Carrega o √°udio melhorado na waveform
            waveSurferEnhanced = createWaveSurfer('#waveformEnhanced');
            waveSurferEnhanced.load(url);
            
            // CONFIGURA√á√ÉO FINAL DOS EVENTOS DE PLAY/PAUSE/PARADA
            // Agora que ambos existem, podemos garantir que um pausa o outro.
            setupWaveSurferEvents(waveSurferOriginal, waveSurferEnhanced, playIconOriginal, pauseIconOriginal);
            setupWaveSurferEvents(waveSurferEnhanced, waveSurferOriginal, playIconEnhanced, pauseIconEnhanced);
            
            playerContainer.style.display = "flex";
            downloadBtn.href = url;
            downloadBtn.download = `enhanced_${selectedFile.name.split('.')[0]}.${document.getElementById("transcode").value.toLowerCase()}`;
            downloadBtn.classList.add('visible');
            resetBtn.classList.add('visible');

        } else if (data.enhancement_status === "FAILED") {
            statusDiv.innerText = "‚ùå O processamento falhou";
            dropZone.classList.remove('processing');
        } else {
            statusDiv.innerText = `‚è≥ Status: ${data.enhancement_status}...`;
            setTimeout(pollStatus, 4000);
        }
    } catch (err) {
        handleError(err);
        dropZone.classList.remove('processing');
        // Tenta novamente em caso de erro de rede
        setTimeout(pollStatus, 5000);
    }
}

function handleError(err) {
    console.error(err);
    let msg = "‚ùå Erro desconhecido.";
    if (err.message.includes("413")) msg = "‚ùå Arquivo muito grande (m√°x 512MB).";
    else if (err.message.includes("415")) msg = "‚ùå Formato n√£o suportado.";
    else if (err.message.includes("401")) msg = "‚ùå API Key inv√°lida.";
    else if (err.message.includes("403")) msg = "‚ùå Acesso negado.";
    else if (err.message.includes("404")) msg = "‚ùå Arquivo n√£o encontrado.";
    statusDiv.innerHTML = `<div class="error">${msg}</div>`;
    dropZone.classList.remove('processing');
}

// --- Inicializa√ß√£o ---
document.addEventListener('DOMContentLoaded', setupEventListeners);
</script>
</body>
</html>
