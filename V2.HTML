<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>AI-Coustics Audio Enhancer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    /* --- Efeitos de Fundo e Estilo Geral --- */
    @keyframes move-twinkle-back {
        from {background-position:0 0;}
        to {background-position:-10000px 5000px;}
    }

    body {
        font-family: 'Poppins', sans-serif;
        background: #000;
        color: #f0f0f0;
        text-align: center;
        padding: 40px;
        overflow-x: hidden; /* Evita scrollbar horizontal dos efeitos */
    }

    .stars, .twinkling {
      position:fixed; /* Fixo para n√£o rolar com o conte√∫do */
      top:0;
      left:0;
      right:0;
      bottom:0;
      width:100%;
      height:100%;
      display:block;
    }

    .stars {
      background:#000 url(https://www.script-tutorials.com/demos/360/images/stars.png) repeat top center;
      z-index:-2;
    }

    .twinkling{
      background:transparent url(https://www.script-tutorials.com/demos/360/images/twinkling.png) repeat top center;
      z-index:-1;
      animation:move-twinkle-back 200s linear infinite;
    }
    
    .content-wrapper {
        position: relative;
        z-index: 1;
    }

    h1, h3 {
        text-shadow: 0 0 8px rgba(0, 191, 255, 0.7);
        letter-spacing: 1.5px;
    }

    h1 {
      font-size: 2.5em;
      font-weight: 600;
    }

    h3 {
      font-size: 1.8em;
      font-weight: 400;
    }

    /* --- Zona de Upload --- */
    #dropZone {
        border: 2px dashed rgba(255, 255, 255, 0.4);
        border-radius: 15px;
        padding: 50px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1.2em;
        color: rgba(255, 255, 255, 0.8);
    }

    #dropZone.hover {
        border-color: #00BFFF;
        background: rgba(0, 191, 255, 0.1);
        box-shadow: 0 0 15px rgba(0, 191, 255, 0.5);
        transform: scale(1.02);
    }

    /* --- Status, Players e Progresso --- */
    #status {
        margin-top: 25px;
        font-weight: bold;
        font-size: 1.1em;
        min-height: 25px;
    }

    #playerContainer {
        display: none;
        margin-top: 30px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
    }

    audio {
        margin: 10px;
        width: 80%;
        max-width: 500px;
        filter: invert(1) hue-rotate(180deg); /* Inverte cores do player para tema escuro */
    }

    #progressContainer {
        display: none;
        margin: 20px auto;
        width: 80%;
        max-width: 600px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    #progressBar {
        width: 0%;
        height: 24px;
        background: linear-gradient(90deg, #00BFFF, #1E90FF);
        transition: width 0.5s ease-out;
        box-shadow: 0 0 10px #1E90FF;
    }

    .error {
        color: #FF4747;
        text-shadow: 0 0 5px #ff4747;
    }

    /* --- Bot√£o de Download --- */
    #downloadBtn {
        display: none;
        margin-top: 20px;
        padding: 12px 25px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        color: #fff;
        background: rgba(0, 191, 255, 0.1);
        border: 2px solid #00BFFF;
        border-radius: 10px;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
        text-shadow: 0 0 5px #00BFFF;
    }

    #downloadBtn:hover {
        background: rgba(0, 191, 255, 0.3);
        box-shadow: 0 0 20px #00BFFF;
        transform: translateY(-3px);
    }

    /* --- Estilo do Modal --- */
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.9); } }

    #paramModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        z-index: 100;
        opacity: 0;
        transition: opacity 0.4s ease;
    }
    
    #paramModal.visible {
        opacity: 1;
    }

    #paramModal .modal-content {
        background: rgba(10, 25, 47, 0.85);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        padding: 30px;
        margin: 10% auto;
        width: 90%;
        max-width: 380px;
        border-radius: 15px;
        text-align: left;
        border: 1px solid rgba(0, 191, 255, 0.4);
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        animation-duration: 0.4s;
        animation-timing-function: ease-out;
    }

    #paramModal.visible .modal-content {
        animation-name: fadeIn;
    }
    
    #paramModal.hidden .modal-content {
        animation-name: fadeOut;
    }

    label {
        display: block;
        margin-top: 15px;
        font-size: 14px;
        font-weight: 300;
        color: rgba(255, 255, 255, 0.7);
    }

    input, select {
        width: 100%;
        padding: 10px;
        margin-top: 8px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        color: #f0f0f0;
        font-family: 'Poppins', sans-serif;
        box-sizing: border-box; /* Garante que padding n√£o afete a largura */
        transition: all 0.3s ease;
    }

    input:focus, select:focus {
        outline: none;
        border-color: #00BFFF;
        box-shadow: 0 0 10px rgba(0, 191, 255, 0.6);
    }

    button#applyParams {
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        background: linear-gradient(45deg, #1E90FF, #00BFFF);
        color: #fff;
        cursor: pointer;
        margin-top: 25px;
        width: 100%;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 150, 255, 0.4);
    }

    button#applyParams:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0, 150, 255, 0.6);
    }
  </style>
</head>
<body>
  <div class="stars"></div>
  <div class="twinkling"></div>

  <div class="content-wrapper">
    <h1>üéµ AI-Coustics Audio Enhancer</h1>
    <div id="dropZone">Clique ou arraste um arquivo de √°udio aqui</div>
    <div id="status"></div>
    <div id="progressContainer"><div id="progressBar"></div></div>
    <div id="playerContainer">
      <h3>üîä Compare</h3>
      <p>Antes:</p>
      <audio id="originalPlayer" controls></audio>
      <p>Depois:</p>
      <audio id="enhancedPlayer" controls></audio>
    </div>
    <a id="downloadBtn" download="enhanced_audio.mp3">‚¨áÔ∏è Baixar √Åudio Melhorado</a>
  </div>

  <!-- Modal de par√¢metros -->
  <div id="paramModal">
    <div class="modal-content">
      <h3>Configura√ß√µes</h3>
      <label for="enhancement_level">N√≠vel de Enhancement (0-100)</label>
      <input type="number" id="enhancement_level" value="100" min="0" max="100">
      <label for="loudness_target">Loudness Target (LUFS)</label>
      <input type="number" id="loudness_target" value="-14" min="-70" max="-5">
      <label for="true_peak">True Peak (dBTP)</label>
      <input type="number" id="true_peak" value="-1" min="-9" max="0">
      <label for="enhancement_model">Modelo</label>
      <select id="enhancement_model">
        <option value="LARK_V2">LARK_V2</option>
        <option value="LARK">LARK</option>
        <option value="FINCH">FINCH</option>
      </select>
      <label for="transcode">Formato</label>
      <select id="transcode">
        <option value="MP3">MP3</option>
        <option value="WAV">WAV</option>
      </select>
      <button id="applyParams">Concluir</button>
    </div>
  </div>

<script>
// A PARTE T√âCNICA (JAVASCRIPT) PERMANECE A MESMA,
// COM PEQUENAS ADI√á√ïES PARA AS ANIMA√á√ïES DO MODAL.

const API_KEY = "9f1c9a6d785ae359b7e9fac9de07349c8a9c0bd2cd6f69d47ddcbcd7a01d8c48";
const API_URL = "https://api.ai-coustics.io/v2/medias";
let selectedFile = null;
let mediaUid = null;

const dropZone = document.getElementById("dropZone");
const statusDiv = document.getElementById("status");
const downloadBtn = document.getElementById("downloadBtn");
const modal = document.getElementById("paramModal");
const applyParamsBtn = document.getElementById("applyParams");
const progressContainer = document.getElementById("progressContainer");
const progressBar = document.getElementById("progressBar");
const playerContainer = document.getElementById("playerContainer");
const originalPlayer = document.getElementById("originalPlayer");
const enhancedPlayer = document.getElementById("enhancedPlayer");

dropZone.addEventListener("click", () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "audio/*";
  input.onchange = e => { selectedFile = e.target.files[0]; if (selectedFile) openModal(); };
  input.click();
});
dropZone.addEventListener("dragover", e => { e.preventDefault(); dropZone.classList.add("hover"); });
dropZone.addEventListener("dragleave", () => dropZone.classList.remove("hover"));
dropZone.addEventListener("drop", e => {
  e.preventDefault();
  dropZone.classList.remove("hover");
  if (e.dataTransfer.files.length > 0) {
    selectedFile = e.dataTransfer.files[0];
    openModal();
  }
});

function openModal() {
    modal.style.display = "block";
    // For√ßa um pequeno reflow para garantir que a transi√ß√£o comece
    setTimeout(() => {
        modal.classList.remove("hidden");
        modal.classList.add("visible");
    }, 10);
}

function closeModal() {
    modal.classList.remove("visible");
    modal.classList.add("hidden");
    // Espera a anima√ß√£o de sa√≠da terminar para esconder o modal
    setTimeout(() => {
        modal.style.display = "none";
    }, 400); // Dura√ß√£o da anima√ß√£o em ms
}

applyParamsBtn.addEventListener("click", () => {
  closeModal();
  uploadFile();
});

async function uploadFile() {
  if (!selectedFile) {
      // Usando o status div para feedback em vez de alert()
      statusDiv.innerHTML = `<div class="error">Nenhum arquivo selecionado.</div>`;
      return;
  }
  statusDiv.innerText = "‚è≥ Enviando arquivo...";
  progressContainer.style.display = "none";
  playerContainer.style.display = "none";
  downloadBtn.style.display = "none";

  const params = {
    loudness_target: parseInt(document.getElementById("loudness_target").value),
    true_peak: parseInt(document.getElementById("true_peak").value),
    enhancement_level: parseInt(document.getElementById("enhancement_level").value),
    enhancement_model: document.getElementById("enhancement_model").value,
    transcode: document.getElementById("transcode").value
  };

  const formData = new FormData();
  formData.append("file", selectedFile);
  formData.append("media_enhancement", JSON.stringify(params));

  try {
    const resp = await fetch(API_URL, {
      method: "POST",
      headers: { "X-API-Key": API_KEY },
      body: formData
    });
    if (!resp.ok) {
      const errText = await resp.text();
      throw new Error(`Upload failed: ${resp.status} ${errText}`);
    }
    const data = await resp.json();
    console.log("Upload response:", data);
    mediaUid = data.uid;
    if (!mediaUid) { statusDiv.innerText = "‚ùå Erro no upload"; return; }

    originalPlayer.src = URL.createObjectURL(selectedFile);

    statusDiv.innerText = "üì° Processando...";
    progressContainer.style.display = "block";
    simulateProgress();
    pollStatus();
  } catch (err) {
    handleError(err);
  }
}

function simulateProgress() {
  progressBar.style.width = "0%";
  let width = 0;
  const interval = setInterval(() => {
    if (width >= 90) { clearInterval(interval); return; }
    width += 5;
    progressBar.style.width = width + "%";
  }, 1000);
}

async function pollStatus() {
  if (!mediaUid) return;
  try {
    const resp = await fetch(`${API_URL}/${mediaUid}/metadata`, {
      headers: { "X-API-Key": API_KEY }
    });
    const data = await resp.json();
    console.log("Metadata:", data);
    if (data.enhancement_status === "COMPLETED") {
      statusDiv.innerText = "‚úÖ Pronto!";
      progressBar.style.width = "100%";

      const fileResp = await fetch(`${API_URL}/${mediaUid}/file?step=ENHANCED`, {
        headers: { "X-API-Key": API_KEY }
      });
      if (!fileResp.ok) throw new Error("Erro ao baixar √°udio processado");
      const blob = await fileResp.blob();
      const url = window.URL.createObjectURL(blob);

      enhancedPlayer.src = url;
      playerContainer.style.display = "block";
      downloadBtn.href = url;
      downloadBtn.download = "enhanced_audio." + (document.getElementById("transcode").value).toLowerCase();
      downloadBtn.style.display = "inline-block";
    } else if (data.enhancement_status === "FAILED") {
      statusDiv.innerText = "‚ùå O processamento falhou";
    } else {
      statusDiv.innerText = "‚è≥ Status: " + data.enhancement_status;
      setTimeout(pollStatus, 4000);
    }
  } catch (err) {
    handleError(err);
    // Retenta a chamada em caso de erro de rede
    setTimeout(pollStatus, 5000);
  }
}

function handleError(err) {
  console.error(err);
  let msg = "‚ùå Erro desconhecido.";
  if (err.message.includes("413")) msg = "‚ùå Arquivo muito grande (m√°x 512MB).";
  else if (err.message.includes("415")) msg = "‚ùå Formato n√£o suportado.";
  else if (err.message.includes("401")) msg = "‚ùå API Key inv√°lida.";
  else if (err.message.includes("403")) msg = "‚ùå Acesso negado.";
  else if (err.message.includes("404")) msg = "‚ùå Arquivo n√£o encontrado.";
  statusDiv.innerHTML = `<div class="error">${msg}</div>`;
}
</script>
</body>
</html>
